# current passPhrase for the uq-pool zone :
UQ-poolBlackJack2021!

# current default image is z1standard (3%CPU average guaranteed), capped at 80%

# Now run for image list:
triton image list

# SHORTID   NAME                   VERSION   FLAGS  OS       TYPE          PUBDATE
# 221635c4  base-64                18.1.0    P      smartos  zone-dataset  2018-04-08
# 5a513a46  base-multiarch         18.1.0    P      smartos  zone-dataset  2018-04-08
# c193a558  base-64-lts            18.4.0    P      smartos  zone-dataset  2019-01-21

# 19aa3328  alpine-3               20170303  P      linux    lx-dataset    2017-03-03
# 7b5981c4  ubuntu-16.04           20170403  P      linux    lx-dataset    2017-04-03
# 3dbbdcca  centos-7               20180323  P      linux    lx-dataset    2018-03-23
# 63d6e664  debian-9               20180404  P      linux    lx-dataset    2018-04-04
# 1246aee0  ubuntu-18.04           20191115  P      linux    lx-dataset    2019-11-15

# 7858da72  ubuntu-krb5            1.0.4     IP     linux    lx-dataset    2020-01-16
# c83d1030  webproject             3.0.4     IP     linux    lx-dataset    2020-01-21
# da39262c  jupyter                1.0.3     IP     linux    lx-dataset    2020-02-11
# 91cca3be  x2go-xfce4             1.0.1     IP     linux    lx-dataset    2020-02-20


# We will choose webproject as it contains most installations ready for use

# Checking networks
triton network list
# SHORTID   NAME               SUBNET            GATEWAY        FABRIC  VLAN  PUBLIC
# ab964f41  My-Fabric-Network  192.168.128.0/22  192.168.128.1  true    2     false
# b10a8f1c  zones              -                 -              -       -     true

# The zone should be fabric and allowed for public access to the website.

# Meta tags for installation of webproject services
services=php mysql nodejs etc...

# Now that weâ€™ve chosen our basic parameters for our zone (a name, a package, an image, and the networks to use), we can finally create it.

# below is what is configured
:
#triton inst create --wait --name uq-pool --network zones webproject z1-standard
# check account limits with
#triton account limit

# ram         512    512

# once setup and installed, use the same credentials (passphrase) as when using sdc-setup, repeated below with user root:
# UQ-poolBlackJack21!

# Example for ssh from within uq zone (moss, mango, vpn etc)
# ssh root@uq-pool.zones.eait.uq.edu.au 

# Adding the team's usernames:
# entering the zone:
triton inst exec uq-pool -- bash -login
# uq-add-user <username>
# triton inst exec uq-pool uq-add-user s4321115

# Connecting from outside UQ for administering the server
# Requires changing the config file with the command below on your local machine
echo """Host *.zones.eait.uq.edu.au
  ProxyJump <SID>@moss.eait.uq.edu.au""" >> ~/.ssh/config

# ssh s4321115@s4321115-uq-pool.zones.eait.uq.edu.au
# type in your uq student password

#In the default state,    nginx    will serve static files from the    /var/www/htdocs 

# Add node js to access other services when a user tries to connect from outside the uq-zone (IE mobile phone on uq-pool app)
# We can see which frameworks are enabled by running the command    
#webprojctl status
#webprojctl enable nodejs
# * Place your project in /var/www/nodejs
# * node will load app.js in that directory -- to change this edit
#webprojctl enable mysql
# * The MySQL "root" user password can be retrieved by running "mdata-get mysql_pw"
#password is: a9737d6a217464dd51c96d38

#students to be added
triton inst exec uq-pool -- bash -login
uq-add-user s46094511
uq-add-user s45829211
uq-add-user s45299038
uq-add-user s43855887
uq-add-user s45829257

# Configuring SSO 
vim /etc/nginx/conf.d/auth.conf

# Below rules are for default allow public access:

map   $uri   $acl   { 
 default   "allow:*"; 
 }

# Once configuration is set run for restarting nanx
systemctl reload nginx

## SSO usage for nodejs is in www/nodejs/app.js.

When a user accesses the nodejs endPoint redirect them to:
https://api.uqcloud.net/login/<final URL>    where <final URL> is replaced by the URL you want the user to come back to after logging in.
